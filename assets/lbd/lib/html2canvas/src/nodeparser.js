function NodeParser(e,t,n,r,o){log("Starting NodeParser"),this.renderer=t,this.options=o,this.range=null,this.support=n,this.renderQueue=[],this.stack=new StackingContext(!0,1,e.ownerDocument,null);var i=new NodeContainer(e,null);if(o.background&&t.rectangle(0,0,t.width,t.height,new Color(o.background)),e===e.ownerDocument.documentElement){var s=new NodeContainer(i.color("backgroundColor").isTransparent()?e.ownerDocument.body:e.ownerDocument.documentElement,null);t.rectangle(0,0,t.width,t.height,s.color("backgroundColor"))}i.visibile=i.isElementVisible(),this.createPseudoHideStyles(e.ownerDocument),this.disableAnimations(e.ownerDocument),this.nodes=flatten([i].concat(this.getChildren(i)).filter(function(e){return e.visible=e.isElementVisible()}).map(this.getPseudoElements,this)),this.fontMetrics=new FontMetrics,log("Fetched nodes, total:",this.nodes.length),log("Calculate overflow clips"),this.calculateOverflowClips(),log("Start fetching images"),this.images=r.fetch(this.nodes.filter(isElement)),this.ready=this.images.ready.then(bind(function(){return log("Images loaded, starting parsing"),log("Creating stacking contexts"),this.createStackingContexts(),log("Sorting stacking contexts"),this.sortStackingContexts(this.stack),this.parse(this.stack),log("Render queue created with "+this.renderQueue.length+" items"),new Promise(bind(function(e){o.async?"function"==typeof o.async?o.async.call(this,this.renderQueue,e):0<this.renderQueue.length?(this.renderIndex=0,this.asyncRenderer(this.renderQueue,e)):e():(this.renderQueue.forEach(this.paint,this),e())},this))},this))}function hasParentClip(e){return e.parent&&e.parent.clip.length}function toCamelCase(e){return e.replace(/(\-[a-z])/g,function(e){return e.toUpperCase().replace("-","")})}function ClearTransform(){}NodeParser.prototype.calculateOverflowClips=function(){this.nodes.forEach(function(e){if(isElement(e)){isPseudoElement(e)&&e.appendToDOM(),e.borders=this.parseBorders(e);var t="hidden"===e.css("overflow")?[e.borders.clip]:[],n=e.parseClip();n&&-1!==["absolute","fixed"].indexOf(e.css("position"))&&t.push([["rect",e.bounds.left+n.left,e.bounds.top+n.top,n.right-n.left,n.bottom-n.top]]),e.clip=hasParentClip(e)?e.parent.clip.concat(t):t,e.backgroundClip="hidden"!==e.css("overflow")?e.clip.concat([e.borders.clip]):e.clip,isPseudoElement(e)&&e.cleanDOM()}else isTextNode(e)&&(e.clip=hasParentClip(e)?e.parent.clip:[]);isPseudoElement(e)||(e.bounds=null)},this)},NodeParser.prototype.asyncRenderer=function(e,t,n){n=n||Date.now(),this.paint(e[this.renderIndex++]),e.length===this.renderIndex?t():n+20>Date.now()?this.asyncRenderer(e,t,n):setTimeout(bind(function(){this.asyncRenderer(e,t)},this),0)},NodeParser.prototype.createPseudoHideStyles=function(e){this.createStyles(e,"."+PseudoElementContainer.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+':before { content: "" !important; display: none !important; }.'+PseudoElementContainer.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER+':after { content: "" !important; display: none !important; }')},NodeParser.prototype.disableAnimations=function(e){this.createStyles(e,"* { -webkit-animation: none !important; -moz-animation: none !important; -o-animation: none !important; animation: none !important; -webkit-transition: none !important; -moz-transition: none !important; -o-transition: none !important; transition: none !important;}")},NodeParser.prototype.createStyles=function(e,t){var n=e.createElement("style");n.innerHTML=t,e.body.appendChild(n)},NodeParser.prototype.getPseudoElements=function(e){var t=[[e]];if(e.node.nodeType===Node.ELEMENT_NODE){var n=this.getPseudoElement(e,":before"),r=this.getPseudoElement(e,":after");n&&t.push(n),r&&t.push(r)}return flatten(t)},NodeParser.prototype.getPseudoElement=function(e,t){var n=e.computedStyle(t);if(!n||!n.content||"none"===n.content||"-moz-alt-content"===n.content||"none"===n.display)return null;for(var r=stripQuotes(n.content),o="url"===r.substr(0,3),i=document.createElement(o?"img":"html2canvaspseudoelement"),s=new PseudoElementContainer(i,e,t),a=n.length-1;0<=a;a--){var d=toCamelCase(n.item(a));i.style[d]=n[d]}if(i.className=PseudoElementContainer.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+" "+PseudoElementContainer.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER,o)return i.src=parseBackgrounds(r)[0].args[0],[s];var c=document.createTextNode(r);return i.appendChild(c),[s,new TextContainer(c,s)]},NodeParser.prototype.getChildren=function(n){return flatten([].filter.call(n.node.childNodes,renderableNode).map(function(e){var t=[e.nodeType===Node.TEXT_NODE?new TextContainer(e,n):new NodeContainer(e,n)].filter(nonIgnoredElement);return e.nodeType===Node.ELEMENT_NODE&&t.length&&"TEXTAREA"!==e.tagName?t[0].isElementVisible()?t.concat(this.getChildren(t[0])):[]:t},this))},NodeParser.prototype.newStackingContext=function(e,t){var n=new StackingContext(t,e.getOpacity(),e.node,e.parent);e.cloneTo(n),(t?n.getParentStack(this):n.parent.stack).contexts.push(n),e.stack=n},NodeParser.prototype.createStackingContexts=function(){this.nodes.forEach(function(e){isElement(e)&&(this.isRootElement(e)||hasOpacity(e)||isPositionedForStacking(e)||this.isBodyWithTransparentRoot(e)||e.hasTransform())?this.newStackingContext(e,!0):isElement(e)&&(isPositioned(e)&&zIndex0(e)||isInlineBlock(e)||isFloating(e))?this.newStackingContext(e,!1):e.assignStack(e.parent.stack)},this)},NodeParser.prototype.isBodyWithTransparentRoot=function(e){return"BODY"===e.node.nodeName&&e.parent.color("backgroundColor").isTransparent()},NodeParser.prototype.isRootElement=function(e){return null===e.parent},NodeParser.prototype.sortStackingContexts=function(e){e.contexts.sort(zIndexSort(e.contexts.slice(0))),e.contexts.forEach(this.sortStackingContexts,this)},NodeParser.prototype.parseTextBounds=function(s){return function(e,t,n){if("none"!==s.parent.css("textDecoration").substr(0,4)||0!==e.trim().length){if(this.support.rangeBounds&&!s.parent.hasTransform()){var r=n.slice(0,t).join("").length;return this.getRangeBounds(s.node,r,e.length)}if(s.node&&"string"==typeof s.node.data){var o=s.node.splitText(e.length),i=this.getWrapperBounds(s.node,s.parent.hasTransform());return s.node=o,i}}else this.support.rangeBounds&&!s.parent.hasTransform()||(s.node=s.node.splitText(e.length));return{}}},NodeParser.prototype.getWrapperBounds=function(e,t){var n=e.ownerDocument.createElement("html2canvaswrapper"),r=e.parentNode,o=e.cloneNode(!0);n.appendChild(e.cloneNode(!0)),r.replaceChild(n,e);var i=t?offsetBounds(n):getBounds(n);return r.replaceChild(o,n),i},NodeParser.prototype.getRangeBounds=function(e,t,n){var r=this.range||(this.range=e.ownerDocument.createRange());return r.setStart(e,t),r.setEnd(e,t+n),r.getBoundingClientRect()},NodeParser.prototype.parse=function(e){var t=e.contexts.filter(negativeZIndex),n=e.children.filter(isElement),r=n.filter(not(isFloating)),o=r.filter(not(isPositioned)).filter(not(inlineLevel)),i=n.filter(not(isPositioned)).filter(isFloating),s=r.filter(not(isPositioned)).filter(inlineLevel),a=e.contexts.concat(r.filter(isPositioned)).filter(zIndex0),d=e.children.filter(isTextNode).filter(hasText),c=e.contexts.filter(positiveZIndex);t.concat(o).concat(i).concat(s).concat(a).concat(d).concat(c).forEach(function(e){this.renderQueue.push(e),isStackingContext(e)&&(this.parse(e),this.renderQueue.push(new ClearTransform))},this)},NodeParser.prototype.paint=function(e){try{e instanceof ClearTransform?this.renderer.ctx.restore():isTextNode(e)?(isPseudoElement(e.parent)&&e.parent.appendToDOM(),this.paintText(e),isPseudoElement(e.parent)&&e.parent.cleanDOM()):this.paintNode(e)}catch(e){if(log(e),this.options.strict)throw e}},NodeParser.prototype.paintNode=function(e){isStackingContext(e)&&(this.renderer.setOpacity(e.opacity),this.renderer.ctx.save(),e.hasTransform()&&this.renderer.setTransform(e.parseTransform())),"INPUT"===e.node.nodeName&&"checkbox"===e.node.type?this.paintCheckbox(e):"INPUT"===e.node.nodeName&&"radio"===e.node.type?this.paintRadio(e):this.paintElement(e)},NodeParser.prototype.paintElement=function(n){var r=n.parseBounds();this.renderer.clip(n.backgroundClip,function(){this.renderer.renderBackground(n,r,n.borders.borders.map(getWidth))},this),this.renderer.clip(n.clip,function(){this.renderer.renderBorders(n.borders.borders)},this),this.renderer.clip(n.backgroundClip,function(){switch(n.node.nodeName){case"svg":case"IFRAME":var e=this.images.get(n.node);e?this.renderer.renderImage(n,r,n.borders,e):log("Error loading <"+n.node.nodeName+">",n.node);break;case"IMG":var t=this.images.get(n.node.src);t?this.renderer.renderImage(n,r,n.borders,t):log("Error loading <img>",n.node.src);break;case"CANVAS":this.renderer.renderImage(n,r,n.borders,{image:n.node});break;case"SELECT":case"INPUT":case"TEXTAREA":this.paintFormValue(n)}},this)},NodeParser.prototype.paintCheckbox=function(e){var t=e.parseBounds(),n=Math.min(t.width,t.height),r={width:n-1,height:n-1,top:t.top,left:t.left},o=[3,3],i=[o,o,o,o],s=[1,1,1,1].map(function(e){return{color:new Color("#A5A5A5"),width:e}}),a=calculateCurvePoints(r,i,s);this.renderer.clip(e.backgroundClip,function(){this.renderer.rectangle(r.left+1,r.top+1,r.width-2,r.height-2,new Color("#DEDEDE")),this.renderer.renderBorders(calculateBorders(s,r,a,i)),e.node.checked&&(this.renderer.font(new Color("#424242"),"normal","normal","bold",n-3+"px","arial"),this.renderer.text("âœ”",r.left+n/6,r.top+n-1))},this)},NodeParser.prototype.paintRadio=function(e){var t=e.parseBounds(),n=Math.min(t.width,t.height)-2;this.renderer.clip(e.backgroundClip,function(){this.renderer.circleStroke(t.left+1,t.top+1,n,new Color("#DEDEDE"),1,new Color("#A5A5A5")),e.node.checked&&this.renderer.circle(Math.ceil(t.left+n/4)+1,Math.ceil(t.top+n/4)+1,Math.floor(n/2),new Color("#424242"))},this)},NodeParser.prototype.paintFormValue=function(t){var e=t.getValue();if(0<e.length){var n=t.node.ownerDocument,r=n.createElement("html2canvaswrapper");["lineHeight","textAlign","fontFamily","fontWeight","fontSize","color","paddingLeft","paddingTop","paddingRight","paddingBottom","width","height","borderLeftStyle","borderTopStyle","borderLeftWidth","borderTopWidth","boxSizing","whiteSpace","wordWrap"].forEach(function(e){try{r.style[e]=t.css(e)}catch(e){log("html2canvas: Parse: Exception caught in renderFormValue: "+e.message)}});var o=t.parseBounds();r.style.position="fixed",r.style.left=o.left+"px",r.style.top=o.top+"px",r.textContent=e,n.body.appendChild(r),this.paintText(new TextContainer(r.firstChild,t)),n.body.removeChild(r)}},NodeParser.prototype.paintText=function(n){n.applyTextTransform();var e=window.html2canvas.punycode.ucs2.decode(n.node.data),r=this.options.letterRendering&&!noLetterSpacing(n)||hasUnicode(n.node.data)?e.map(function(e){return window.html2canvas.punycode.ucs2.encode([e])}):getWords(e),t=n.parent.fontWeight(),o=n.parent.css("fontSize"),i=n.parent.css("fontFamily"),s=n.parent.parseTextShadows();this.renderer.font(n.parent.color("color"),n.parent.css("fontStyle"),n.parent.css("fontVariant"),t,o,i),s.length?this.renderer.fontShadow(s[0].color,s[0].offsetX,s[0].offsetY,s[0].blur):this.renderer.clearShadow(),this.renderer.clip(n.parent.clip,function(){r.map(this.parseTextBounds(n),this).forEach(function(e,t){e&&(this.renderer.text(r[t],e.left,e.bottom),this.renderTextDecoration(n.parent,e,this.fontMetrics.getMetrics(i,o)))},this)},this)},NodeParser.prototype.renderTextDecoration=function(e,t,n){switch(e.css("textDecoration").split(" ")[0]){case"underline":this.renderer.rectangle(t.left,Math.round(t.top+n.baseline+n.lineWidth),t.width,1,e.color("color"));break;case"overline":this.renderer.rectangle(t.left,Math.round(t.top),t.width,1,e.color("color"));break;case"line-through":this.renderer.rectangle(t.left,Math.ceil(t.top+n.middle+n.lineWidth),t.width,1,e.color("color"))}};var borderColorTransforms={inset:[["darken",.6],["darken",.1],["darken",.1],["darken",.6]]};function calculateBorders(s,a,d,c){return s.map(function(e,t){if(0<e.width){var n=a.left,r=a.top,o=a.width,i=a.height-s[2].width;switch(t){case 0:i=s[0].width,e.args=drawSide({c1:[n,r],c2:[n+o,r],c3:[n+o-s[1].width,r+i],c4:[n+s[3].width,r+i]},c[0],c[1],d.topLeftOuter,d.topLeftInner,d.topRightOuter,d.topRightInner);break;case 1:n=a.left+a.width-s[1].width,o=s[1].width,e.args=drawSide({c1:[n+o,r],c2:[n+o,r+i+s[2].width],c3:[n,r+i],c4:[n,r+s[0].width]},c[1],c[2],d.topRightOuter,d.topRightInner,d.bottomRightOuter,d.bottomRightInner);break;case 2:r=r+a.height-s[2].width,i=s[2].width,e.args=drawSide({c1:[n+o,r+i],c2:[n,r+i],c3:[n+s[3].width,r],c4:[n+o-s[3].width,r]},c[2],c[3],d.bottomRightOuter,d.bottomRightInner,d.bottomLeftOuter,d.bottomLeftInner);break;case 3:o=s[3].width,e.args=drawSide({c1:[n,r+i+s[2].width],c2:[n,r],c3:[n+o,r+s[0].width],c4:[n+o,r+i]},c[3],c[0],d.bottomLeftOuter,d.bottomLeftInner,d.topLeftOuter,d.topLeftInner)}}return e})}function getCurvePoints(e,t,n,r){var o=(Math.sqrt(2)-1)/3*4,i=n*o,s=r*o,a=e+n,d=t+r;return{topLeft:bezierCurve({x:e,y:d},{x:e,y:d-s},{x:a-i,y:t},{x:a,y:t}),topRight:bezierCurve({x:e,y:t},{x:e+i,y:t},{x:a,y:d-s},{x:a,y:d}),bottomRight:bezierCurve({x:a,y:t},{x:a,y:t+s},{x:e+i,y:d},{x:e,y:d}),bottomLeft:bezierCurve({x:a,y:d},{x:a-i,y:d},{x:e,y:t+s},{x:e,y:t})}}function calculateCurvePoints(e,t,n){var r=e.left,o=e.top,i=e.width,s=e.height,a=t[0][0],d=t[0][1],c=t[1][0],l=t[1][1],u=t[2][0],h=t[2][1],p=t[3][0],f=t[3][1],g=i-c,m=s-h,b=i-u,y=s-f;return{topLeftOuter:getCurvePoints(r,o,a,d).topLeft.subdivide(.5),topLeftInner:getCurvePoints(r+n[3].width,o+n[0].width,Math.max(0,a-n[3].width),Math.max(0,d-n[0].width)).topLeft.subdivide(.5),topRightOuter:getCurvePoints(r+g,o,c,l).topRight.subdivide(.5),topRightInner:getCurvePoints(r+Math.min(g,i+n[3].width),o+n[0].width,g>i+n[3].width?0:c-n[3].width,l-n[0].width).topRight.subdivide(.5),bottomRightOuter:getCurvePoints(r+b,o+m,u,h).bottomRight.subdivide(.5),bottomRightInner:getCurvePoints(r+Math.min(b,i-n[3].width),o+Math.min(m,s+n[0].width),Math.max(0,u-n[1].width),h-n[2].width).bottomRight.subdivide(.5),bottomLeftOuter:getCurvePoints(r,o+y,p,f).bottomLeft.subdivide(.5),bottomLeftInner:getCurvePoints(r+n[3].width,o+y,Math.max(0,p-n[3].width),f-n[2].width).bottomLeft.subdivide(.5)}}function bezierCurve(a,d,c,l){function u(e,t,n){return{x:e.x+(t.x-e.x)*n,y:e.y+(t.y-e.y)*n}}return{start:a,startControl:d,endControl:c,end:l,subdivide:function(e){var t=u(a,d,e),n=u(d,c,e),r=u(c,l,e),o=u(t,n,e),i=u(n,r,e),s=u(o,i,e);return[bezierCurve(a,t,o,s),bezierCurve(s,i,r,l)]},curveTo:function(e){e.push(["bezierCurve",d.x,d.y,c.x,c.y,l.x,l.y])},curveToReversed:function(e){e.push(["bezierCurve",c.x,c.y,d.x,d.y,a.x,a.y])}}}function drawSide(e,t,n,r,o,i,s){var a=[];return 0<t[0]||0<t[1]?(a.push(["line",r[1].start.x,r[1].start.y]),r[1].curveTo(a)):a.push(["line",e.c1[0],e.c1[1]]),0<n[0]||0<n[1]?(a.push(["line",i[0].start.x,i[0].start.y]),i[0].curveTo(a),a.push(["line",s[0].end.x,s[0].end.y]),s[0].curveToReversed(a)):(a.push(["line",e.c2[0],e.c2[1]]),a.push(["line",e.c3[0],e.c3[1]])),0<t[0]||0<t[1]?(a.push(["line",o[1].end.x,o[1].end.y]),o[1].curveToReversed(a)):a.push(["line",e.c4[0],e.c4[1]]),a}function parseCorner(e,t,n,r,o,i,s){0<t[0]||0<t[1]?(e.push(["line",r[0].start.x,r[0].start.y]),r[0].curveTo(e),r[1].curveTo(e)):e.push(["line",i,s]),(0<n[0]||0<n[1])&&e.push(["line",o[0].start.x,o[0].start.y])}function negativeZIndex(e){return e.cssInt("zIndex")<0}function positiveZIndex(e){return 0<e.cssInt("zIndex")}function zIndex0(e){return 0===e.cssInt("zIndex")}function inlineLevel(e){return-1!==["inline","inline-block","inline-table"].indexOf(e.css("display"))}function isStackingContext(e){return e instanceof StackingContext}function hasText(e){return 0<e.node.data.trim().length}function noLetterSpacing(e){return/^(normal|none|0px)$/.test(e.parent.css("letterSpacing"))}function getBorderRadiusData(n){return["TopLeft","TopRight","BottomRight","BottomLeft"].map(function(e){var t=n.css("border"+e+"Radius").split(" ");return t.length<=1&&(t[1]=t[0]),t.map(asInt)})}function renderableNode(e){return e.nodeType===Node.TEXT_NODE||e.nodeType===Node.ELEMENT_NODE}function isPositionedForStacking(e){var t=e.css("position");return"auto"!==(-1!==["absolute","relative","fixed"].indexOf(t)?e.css("zIndex"):"auto")}function isPositioned(e){return"static"!==e.css("position")}function isFloating(e){return"none"!==e.css("float")}function isInlineBlock(e){return-1!==["inline-block","inline-table"].indexOf(e.css("display"))}function not(e){var t=this;return function(){return!e.apply(t,arguments)}}function isElement(e){return e.node.nodeType===Node.ELEMENT_NODE}function isPseudoElement(e){return!0===e.isPseudoElement}function isTextNode(e){return e.node.nodeType===Node.TEXT_NODE}function zIndexSort(n){return function(e,t){return e.cssInt("zIndex")+n.indexOf(e)/n.length-(t.cssInt("zIndex")+n.indexOf(t)/n.length)}}function hasOpacity(e){return e.getOpacity()<1}function bind(e,t){return function(){return e.apply(t,arguments)}}function asInt(e){return parseInt(e,10)}function getWidth(e){return e.width}function nonIgnoredElement(e){return e.node.nodeType!==Node.ELEMENT_NODE||-1===["SCRIPT","HEAD","TITLE","OBJECT","BR","OPTION"].indexOf(e.node.nodeName)}function flatten(e){return[].concat.apply([],e)}function stripQuotes(e){var t=e.substr(0,1);return t===e.substr(e.length-1)&&t.match(/'|"/)?e.substr(1,e.length-2):e}function getWords(e){for(var t,n=[],r=0,o=!1;e.length;)isWordBoundary(e[r])===o?((t=e.splice(0,r)).length&&n.push(window.html2canvas.punycode.ucs2.encode(t)),o=!o,r=0):r++,r>=e.length&&(t=e.splice(0,r)).length&&n.push(window.html2canvas.punycode.ucs2.encode(t));return n}function isWordBoundary(e){return-1!==[32,13,10,9,45].indexOf(e)}function hasUnicode(e){return/[^\u0000-\u00ff]/.test(e)}NodeParser.prototype.parseBorders=function(i){var e=i.parseBounds(),t=getBorderRadiusData(i),n=["Top","Right","Bottom","Left"].map(function(e,t){var n=i.css("border"+e+"Style"),r=i.color("border"+e+"Color");"inset"===n&&r.isBlack()&&(r=new Color([255,255,255,r.a]));var o=borderColorTransforms[n]?borderColorTransforms[n][t]:null;return{width:i.cssInt("border"+e+"Width"),color:o?r[o[0]](o[1]):r,args:null}}),r=calculateCurvePoints(e,t,n);return{clip:this.parseBackgroundClip(i,r,n,t,e),borders:calculateBorders(n,e,r,t)}},NodeParser.prototype.parseBackgroundClip=function(e,t,n,r,o){var i=[];switch(e.css("backgroundClip")){case"content-box":case"padding-box":parseCorner(i,r[0],r[1],t.topLeftInner,t.topRightInner,o.left+n[3].width,o.top+n[0].width),parseCorner(i,r[1],r[2],t.topRightInner,t.bottomRightInner,o.left+o.width-n[1].width,o.top+n[0].width),parseCorner(i,r[2],r[3],t.bottomRightInner,t.bottomLeftInner,o.left+o.width-n[1].width,o.top+o.height-n[2].width),parseCorner(i,r[3],r[0],t.bottomLeftInner,t.topLeftInner,o.left+n[3].width,o.top+o.height-n[2].width);break;default:parseCorner(i,r[0],r[1],t.topLeftOuter,t.topRightOuter,o.left,o.top),parseCorner(i,r[1],r[2],t.topRightOuter,t.bottomRightOuter,o.left+o.width,o.top),parseCorner(i,r[2],r[3],t.bottomRightOuter,t.bottomLeftOuter,o.left+o.width,o.top+o.height),parseCorner(i,r[3],r[0],t.bottomLeftOuter,t.topLeftOuter,o.left,o.top+o.height)}return i};