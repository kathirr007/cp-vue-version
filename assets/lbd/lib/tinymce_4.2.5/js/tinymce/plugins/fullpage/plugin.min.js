tinymce.PluginManager.add("fullpage",function(m){function u(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(g)}var g,f,y=tinymce.each,s=tinymce.html.Node;m.addCommand("mceFullPageProperties",function(){var t=function(){function e(e,t){var n=e.attr(t);return n||""}var t,n,l=u(),i={};return i.fontface=m.getParam("fullpage_default_fontface",""),i.fontsize=m.getParam("fullpage_default_fontsize",""),7==(t=l.firstChild).type&&(i.xml_pi=!0,(n=/encoding="([^"]+)"/.exec(t.value))&&(i.docencoding=n[1])),(t=l.getAll("#doctype")[0])&&(i.doctype="<!DOCTYPE"+t.value+">"),(t=l.getAll("title")[0])&&t.firstChild&&(i.title=t.firstChild.value),y(l.getAll("meta"),function(e){var t,n=e.attr("name"),l=e.attr("http-equiv");n?i[n.toLowerCase()]=e.attr("content"):"Content-Type"!=l||(t=/charset\s*=\s*(.*)\s*/gi.exec(e.attr("content")))&&(i.docencoding=t[1])}),(t=l.getAll("html")[0])&&(i.langcode=e(t,"lang")||e(t,"xml:lang")),i.stylesheets=[],tinymce.each(l.getAll("link"),function(e){"stylesheet"==e.attr("rel")&&i.stylesheets.push(e.attr("href"))}),(t=l.getAll("body")[0])&&(i.langdir=e(t,"dir"),i.style=e(t,"style"),i.visited_color=e(t,"vlink"),i.link_color=e(t,"link"),i.active_color=e(t,"alink")),i}();m.windowManager.open({title:"Document properties",data:t,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(e){!function(a){function e(e,t,n){e.attr(t,n||void 0)}function r(e){t.firstChild?t.insert(e,t.firstChild):t.append(e)}var o,t,n,c,l,i=m.dom;o=u(),(t=o.getAll("head")[0])||(c=o.getAll("html")[0],t=new s("head",1),c.firstChild?c.insert(t,c.firstChild,!0):c.append(t)),c=o.firstChild,a.xml_pi?(l='version="1.0"',a.docencoding&&(l+=' encoding="'+a.docencoding+'"'),7!=c.type&&(c=new s("xml",7),o.insert(c,o.firstChild,!0)),c.value=l):c&&7==c.type&&c.remove(),c=o.getAll("#doctype")[0],a.doctype?(c||(c=new s("#doctype",10),a.xml_pi?o.insert(c,o.firstChild):r(c)),c.value=a.doctype.substring(9,a.doctype.length-1)):c&&c.remove(),c=null,y(o.getAll("meta"),function(e){"Content-Type"==e.attr("http-equiv")&&(c=e)}),a.docencoding?(c||((c=new s("meta",1)).attr("http-equiv","Content-Type"),c.shortEnded=!0,r(c)),c.attr("content","text/html; charset="+a.docencoding)):c&&c.remove(),c=o.getAll("title")[0],a.title?(c?c.empty():r(c=new s("title",1)),c.append(new s("#text",3)).value=a.title):c&&c.remove(),y("keywords,description,author,copyright,robots".split(","),function(e){var t,n,l=o.getAll("meta"),i=a[e];for(t=0;t<l.length;t++)if((n=l[t]).attr("name")==e)return void(i?n.attr("content",i):n.remove());i&&((c=new s("meta",1)).attr("name",e),c.attr("content",i),c.shortEnded=!0,r(c))});var d={};tinymce.each(o.getAll("link"),function(e){"stylesheet"==e.attr("rel")&&(d[e.attr("href")]=e)}),tinymce.each(a.stylesheets,function(e){d[e]||((c=new s("link",1)).attr({rel:"stylesheet",text:"text/css",href:e}),c.shortEnded=!0,r(c)),delete d[e]}),tinymce.each(d,function(e){e.remove()}),(c=o.getAll("body")[0])&&(e(c,"dir",a.langdir),e(c,"style",a.style),e(c,"vlink",a.visited_color),e(c,"link",a.link_color),e(c,"alink",a.active_color),i.setAttribs(m.getBody(),{style:a.style,dir:a.dir,vLink:a.visited_color,link:a.link_color,aLink:a.active_color})),(c=o.getAll("html")[0])&&(e(c,"lang",a.langcode),e(c,"xml:lang",a.langcode)),t.firstChild||t.remove(),n=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(o),g=n.substring(0,n.indexOf("</body>"))}(tinymce.extend(t,e.data))}})}),m.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),m.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),m.on("BeforeSetContent",function(e){function t(e){return e.replace(/<\/?[A-Z]+/g,function(e){return e.toLowerCase()})}var n,l,i,a,r=e.content,o="",c=m.dom;if(!e.selection&&!("raw"==e.format&&g||e.source_view&&m.getParam("fullpage_hide_in_source_view"))){0!==r.length||e.source_view||(r=tinymce.trim(g)+"\n"+tinymce.trim(r)+"\n"+tinymce.trim(f)),n=(r=r.replace(/<(\/?)BODY/gi,"<$1body")).indexOf("<body"),f=-1!=n?(n=r.indexOf(">",n),g=t(r.substring(0,n+1)),-1==(l=r.indexOf("</body",n))&&(l=r.length),e.content=r.substring(n+1,l),t(r.substring(l))):(g=function(){var e,t="",n="";return m.getParam("fullpage_default_xml_pi")&&(t+='<?xml version="1.0" encoding="'+m.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),t+=m.getParam("fullpage_default_doctype","<!DOCTYPE html>"),t+="\n<html>\n<head>\n",(e=m.getParam("fullpage_default_title"))&&(t+="<title>"+e+"</title>\n"),(e=m.getParam("fullpage_default_encoding"))&&(t+='<meta http-equiv="Content-Type" content="text/html; charset='+e+'" />\n'),(e=m.getParam("fullpage_default_font_family"))&&(n+="font-family: "+e+";"),(e=m.getParam("fullpage_default_font_size"))&&(n+="font-size: "+e+";"),(e=m.getParam("fullpage_default_text_color"))&&(n+="color: "+e+";"),t+="</head>\n<body"+(n?' style="'+n+'"':"")+">\n"}(),"\n</body>\n</html>"),i=u(),y(i.getAll("style"),function(e){e.firstChild&&(o+=e.firstChild.value)}),(a=i.getAll("body")[0])&&c.setAttribs(m.getBody(),{style:a.attr("style")||"",dir:a.attr("dir")||"",vLink:a.attr("vlink")||"",link:a.attr("link")||"",aLink:a.attr("alink")||""}),c.remove("fullpage_styles");var d=m.getDoc().getElementsByTagName("head")[0];o&&(c.add(d,"style",{id:"fullpage_styles"},o),(a=c.get("fullpage_styles")).styleSheet&&(a.styleSheet.cssText=o));var s={};tinymce.each(d.getElementsByTagName("link"),function(e){"stylesheet"==e.rel&&e.getAttribute("data-mce-fullpage")&&(s[e.href]=e)}),tinymce.each(i.getAll("link"),function(e){var t=e.attr("href");s[t]||"stylesheet"!=e.attr("rel")||c.add(d,"link",{rel:"stylesheet",text:"text/css",href:t,"data-mce-fullpage":"1"}),delete s[t]}),tinymce.each(s,function(e){e.parentNode.removeChild(e)})}}),m.on("GetContent",function(e){e.selection||e.source_view&&m.getParam("fullpage_hide_in_source_view")||(e.content=tinymce.trim(g)+"\n"+tinymce.trim(e.content)+"\n"+tinymce.trim(f))})});