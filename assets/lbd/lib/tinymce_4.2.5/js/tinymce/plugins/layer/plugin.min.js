tinymce.PluginManager.add("layer",function(s){function l(e){do{if(e.className&&-1!=e.className.indexOf("mceItemLayer"))return e}while(e=e.parentNode)}function e(e){var t,o,d=[],n=l(s.selection.getNode()),a=-1,i=-1;for(o=[],tinymce.walk(s.getBody(),function(e){1==e.nodeType&&/^(absolute|relative|static)$/i.test(e.style.position)&&o.push(e)},"childNodes"),t=0;t<o.length;t++)d[t]=o[t].style.zIndex?parseInt(o[t].style.zIndex,10):0,a<0&&o[t]==n&&(a=t);if(e<0){for(t=0;t<d.length;t++)if(d[t]<d[a]){i=t;break}-1<i?(o[a].style.zIndex=d[i],o[i].style.zIndex=d[a]):0<d[a]&&(o[a].style.zIndex=d[a]-1)}else{for(t=0;t<d.length;t++)if(d[t]>d[a]){i=t;break}-1<i?(o[a].style.zIndex=d[i],o[i].style.zIndex=d[a]):o[a].style.zIndex=d[a]+1}s.execCommand("mceRepaint")}s.addCommand("mceInsertLayer",function(){var e=s.dom,t=e.getPos(e.getParent(s.selection.getNode(),"*")),o=s.getBody();s.dom.add(o,"div",{style:{position:"absolute",left:t.x,top:20<t.y?t.y:20,width:100,height:100},class:"mceItemVisualAid mceItemLayer"},s.selection.getContent()||s.getLang("layer.content")),tinymce.Env.ie&&e.setHTML(o,o.innerHTML)}),s.addCommand("mceMoveForward",function(){e(1)}),s.addCommand("mceMoveBackward",function(){e(-1)}),s.addCommand("mceMakeAbsolute",function(){!function(){var e=l(s.selection.getNode());e||(e=s.dom.getParent(s.selection.getNode(),"DIV,P,IMG")),e&&("absolute"==e.style.position.toLowerCase()?(s.dom.setStyles(e,{position:"",left:"",top:"",width:"",height:""}),s.dom.removeClass(e,"mceItemVisualAid"),s.dom.removeClass(e,"mceItemLayer")):(e.style.left||(e.style.left="20px"),e.style.top||(e.style.top="20px"),e.style.width||(e.style.width=e.width?e.width+"px":"100px"),e.style.height||(e.style.height=e.height?e.height+"px":"100px"),e.style.position="absolute",s.dom.setAttrib(e,"data-mce-style",""),s.addVisual(s.getBody())),s.execCommand("mceRepaint"),s.nodeChanged())}()}),s.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"}),s.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"}),s.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"}),s.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"}),s.on("init",function(){tinymce.Env.ie&&s.getDoc().execCommand("2D-Position",!1,!0)}),s.on("mouseup",function(e){var t=l(e.target);t&&s.dom.setAttrib(t,"data-mce-style","")}),s.on("mousedown",function(e){var t,o=e.target,d=s.getDoc();tinymce.Env.gecko&&(l(o)?"on"!==d.designMode&&(d.designMode="on",(t=(o=d.body).parentNode).removeChild(o),t.appendChild(o)):"on"==d.designMode&&(d.designMode="off"))}),s.on("NodeChange",function(e){var t=s.dom;tinymce.each(t.select("div,p",e),function(e){/^(absolute|relative|fixed)$/i.test(e.style.position)&&(e.hasVisual?t.addClass(e,"mceItemVisualAid"):t.removeClass(e,"mceItemVisualAid"),t.addClass(e,"mceItemLayer"))})})});