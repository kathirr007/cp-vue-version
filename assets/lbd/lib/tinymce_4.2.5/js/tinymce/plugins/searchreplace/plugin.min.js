tinymce.PluginManager.add("searchreplace",function(f){function t(){function i(){l.statusbar.find("#next").disabled(!h(x+1).length),l.statusbar.find("#prev").disabled(!h(x-1).length)}function d(){tinymce.ui.MessageBox.alert("Could not find the specified string.",function(){l.find("#find")[0].focus()})}var e,o={};e=tinymce.trim(f.selection.getContent({format:"text"}));var l=tinymce.ui.Factory.create({type:"window",layout:"flex",pack:"center",align:"center",onClose:function(){f.focus(),v.done()},onSubmit:function(e){var t,n,a,r;return e.preventDefault(),n=l.find("#case").checked(),r=l.find("#words").checked(),(a=l.find("#find").value()).length?o.text==a&&o.caseState==n&&o.wholeWord==r?0===h(x+1).length?void d():(v.next(),void i()):((t=v.find(a,n,r))||d(),l.statusbar.items().slice(1).disabled(0===t),i(),void(o={text:a,caseState:n,wholeWord:r})):(v.done(!1),void l.statusbar.items().slice(1).disabled(!0))},buttons:[{text:"Find",subtype:"primary",onclick:function(){l.submit()}},{text:"Replace",disabled:!0,onclick:function(){v.replace(l.find("#replace").value())||(l.statusbar.items().slice(1).disabled(!0),x=-1,o={})}},{text:"Replace all",disabled:!0,onclick:function(){v.replace(l.find("#replace").value(),!0,!0),l.statusbar.items().slice(1).disabled(!0),o={}}},{type:"spacer",flex:1},{text:"Prev",name:"prev",disabled:!0,onclick:function(){v.prev(),i()}},{text:"Next",name:"next",disabled:!0,onclick:function(){v.next(),i()}}],title:"Find and replace",items:{type:"form",padding:20,labelGap:30,spacing:10,items:[{type:"textbox",name:"find",size:40,label:"Find",value:e},{type:"textbox",name:"replace",size:40,label:"Replace with"},{type:"checkbox",name:"case",text:"Match case",label:" "},{type:"checkbox",name:"words",text:"Whole words",label:" "}]}}).renderTo().reflow()}function u(e){var t=e.getAttribute("data-mce-index");return"number"==typeof t?""+t:t}function m(e){var t=e.parentNode;e.firstChild&&t.insertBefore(e.firstChild,e),e.parentNode.removeChild(e)}function h(e){var t,n=[];if((t=tinymce.toArray(f.getBody().getElementsByTagName("span"))).length)for(var a=0;a<t.length;a++){var r=u(t[a]);null!==r&&r.length&&r===e.toString()&&n.push(t[a])}return n}function r(e){var t=x,n=f.dom;(e=!1!==e)?t++:t--,n.removeClass(h(x),"mce-match-marker-selected");var a=h(t);return a.length?(n.addClass(h(t),"mce-match-marker-selected"),f.selection.scrollIntoView(a[0]),t):-1}function p(e){var t=f.dom,n=e.parentNode;t.remove(e),t.isEmpty(n)&&t.remove(n)}function g(e){var t=u(e);return null!==t&&0<t.length}var v=this,x=-1;v.init=function(e){e.addMenuItem("searchreplace",{text:"Find and replace",shortcut:"Meta+F",onclick:t,separator:"before",context:"edit"}),e.addButton("searchreplace",{tooltip:"Find and replace",shortcut:"Meta+F",onclick:t}),e.addCommand("SearchReplace",t),e.shortcuts.add("Meta+F","",t)},v.find=function(e,t,n){e=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e=n?"\\b"+e+"\\b":e;var a=function(e){var t,n;return(n=f.dom.create("span",{"data-mce-bogus":1})).className="mce-match-marker",t=f.getBody(),v.done(!1),function(e,t,n,a,r){function i(e,t){if(t=t||0,!e[0])throw"findAndReplaceDOMText cannot handle zero-length matches";var n=e.index;if(0<t){var a=e[t];if(!a)throw"Invalid capture group";n+=e[0].indexOf(a),e[0]=a}return[n,n+e[0].length,[e[0]]]}var d,o,v,u,m,h,l=[],c=0;if(v=t.ownerDocument,u=r.getBlockElements(),m=r.getWhiteSpaceElements(),h=r.getShortEndedElements(),o=function e(t){var n;if(3===t.nodeType)return t.data;if(m[t.nodeName]&&!u[t.nodeName])return"";if(n="",(u[t.nodeName]||h[t.nodeName])&&(n+="\n"),t=t.firstChild)for(;n+=e(t),t=t.nextSibling;);return n}(t)){if(e.global)for(;d=e.exec(o);)l.push(i(d,a));else d=o.match(e),l.push(i(d,a));return l.length&&(c=l.length,function(e,t,n){var a,r,i,d,o=[],l=0,c=e,s=t.shift(),f=0;e:for(;;){if((u[c.nodeName]||h[c.nodeName])&&l++,3===c.nodeType&&(!r&&c.length+l>=s[1]?(r=c,d=s[1]-l):a&&o.push(c),!a&&c.length+l>s[0]&&(a=c,i=s[0]-l),l+=c.length),a&&r){if(c=n({startNode:a,startNodeIndex:i,endNode:r,endNodeIndex:d,innerNodes:o,match:s[2],matchIndex:f}),l-=r.length-d,r=a=null,o=[],f++,!(s=t.shift()))break}else{if((!m[c.nodeName]||u[c.nodeName])&&c.firstChild){c=c.firstChild;continue}if(c.nextSibling){c=c.nextSibling;continue}}for(;;){if(c.nextSibling){c=c.nextSibling;break}if(c.parentNode===e)break e;c=c.parentNode}}}(t,l,function(e){var g;if("function"!=typeof e){var a=e.nodeType?e:v.createElement(e);g=function(e,t){var n=a.cloneNode(!1);return n.setAttribute("data-mce-index",t),e&&n.appendChild(v.createTextNode(e)),n}}else g=e;return function(e){var t,n,a,r=e.startNode,i=e.endNode,d=e.matchIndex;if(r===i){var o=r;a=o.parentNode,0<e.startNodeIndex&&(t=v.createTextNode(o.data.substring(0,e.startNodeIndex)),a.insertBefore(t,o));var l=g(e.match[0],d);return a.insertBefore(l,o),e.endNodeIndex<o.length&&(n=v.createTextNode(o.data.substring(e.endNodeIndex)),a.insertBefore(n,o)),o.parentNode.removeChild(o),l}t=v.createTextNode(r.data.substring(0,e.startNodeIndex)),n=v.createTextNode(i.data.substring(e.endNodeIndex));for(var c=g(r.data.substring(e.startNodeIndex),d),s=[],f=0,u=e.innerNodes.length;f<u;++f){var m=e.innerNodes[f],h=g(m.data,d);m.parentNode.replaceChild(h,m),s.push(h)}var p=g(i.data.substring(0,e.endNodeIndex),d);return(a=r.parentNode).insertBefore(t,r),a.insertBefore(c,r),a.removeChild(r),(a=i.parentNode).insertBefore(p,i),a.insertBefore(n,i),a.removeChild(i),p}}(n))),c}}(e,t,n,!1,f.schema)}(new RegExp(e,t?"g":"gi"));return a&&(x=-1,x=r(!0)),a},v.next=function(){var e=r(!0);-1!==e&&(x=e)},v.prev=function(){var e=r(!1);-1!==e&&(x=e)},v.replace=function(e,t,n){var a,r,i,d,o,l,c=x;for(t=!1!==t,i=f.getBody(),r=tinymce.grep(tinymce.toArray(i.getElementsByTagName("span")),g),a=0;a<r.length;a++){var s=u(r[a]);if(d=o=parseInt(s,10),n||d===x){for(e.length?(r[a].firstChild.nodeValue=e,m(r[a])):p(r[a]);r[++a];){if((d=parseInt(u(r[a]),10))!==o){a--;break}p(r[a])}t&&c--}else x<o&&r[a].setAttribute("data-mce-index",o-1)}return f.undoManager.add(),x=c,t?(l=0<h(c+1).length,v.next()):(l=0<h(c-1).length,v.prev()),!n&&l},v.done=function(e){var t,n,a,r;for(n=tinymce.toArray(f.getBody().getElementsByTagName("span")),t=0;t<n.length;t++){var i=u(n[t]);null!==i&&i.length&&(i===x.toString()&&(a||(a=n[t].firstChild),r=n[t].firstChild),m(n[t]))}if(a&&r){var d=f.dom.createRng();return d.setStart(a,0),d.setEnd(r,r.data.length),!1!==e&&f.selection.setRng(d),d}}});