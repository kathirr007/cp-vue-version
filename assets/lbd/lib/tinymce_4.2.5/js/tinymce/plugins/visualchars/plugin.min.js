tinymce.PluginManager.add("visualchars",function(m){function n(e){function n(e){return'<span data-mce-bogus="1" class="mce-'+c[e]+'">'+e+"</span>"}var t,a,o,r,s,i,c,d,l=m.getBody(),u=m.selection;if(c={" ":"nbsp","­":"shy"},f=!f,h.state=f,m.fire("VisualChars",{state:f}),d=function(){var e,n="";for(e in c)n+=e;return new RegExp("["+n+"]","g")}(),e&&(i=u.getBookmark()),f)for(a=[],tinymce.walk(l,function(e){3==e.nodeType&&e.nodeValue&&d.test(e.nodeValue)&&a.push(e)},"childNodes"),o=0;o<a.length;o++){for(r=(r=a[o].nodeValue).replace(d,n),s=m.dom.create("div",null,r);t=s.lastChild;)m.dom.insertAfter(t,a[o]);m.dom.remove(a[o])}else for(o=(a=m.dom.select(function(){var e,n="";for(e in c)n&&(n+=","),n+="span.mce-"+c[e];return n}(),l)).length-1;0<=o;o--)m.dom.remove(a[o],1);u.moveToBookmark(i)}function e(){var n=this;m.on("VisualChars",function(e){n.active(e.state)})}var f,h=this;m.addCommand("mceVisualChars",n),m.addButton("visualchars",{title:"Show invisible characters",cmd:"mceVisualChars",onPostRender:e}),m.addMenuItem("visualchars",{text:"Show invisible characters",cmd:"mceVisualChars",onPostRender:e,selectable:!0,context:"view",prependToContext:!0}),m.on("beforegetcontent",function(e){f&&"raw"!=e.format&&!e.draft&&n(!(f=!0))})});