tinymce.PluginManager.add("media",function(u,r){function o(e){return-1!=(e=e.toLowerCase()).indexOf(".mp3")?"audio/mpeg":-1!=e.indexOf(".wav")?"audio/wav":-1!=e.indexOf(".mp4")?"video/mp4":-1!=e.indexOf(".webm")?"video/webm":-1!=e.indexOf(".ogg")?"video/ogg":-1!=e.indexOf(".swf")?"application/x-shockwave-flash":""}function d(e){var t=u.settings.media_scripts;if(t)for(var i=0;i<t.length;i++)if(-1!==e.indexOf(t[i].filter))return t[i]}function e(){function e(e){var t,i,r,a;t=o.find("#width")[0],i=o.find("#height")[0],r=t.value(),a=i.value(),o.find("#constrain")[0].checked()&&c&&n&&r&&a&&(e.control==t?(a=Math.round(r/c*a),isNaN(a)||i.value(a)):(r=Math.round(a/n*r),isNaN(r)||t.value(r))),c=r,n=a}var o,c,n,t,i=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(e){tinymce.each(e.meta,function(e,t){o.find("#"+t).value(e)})}}];!1!==u.settings.media_alt_source&&i.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),!1!==u.settings.media_poster&&i.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),!1!==u.settings.media_dimensions&&i.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:e,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:e,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),t=function(e){return e.getAttribute("data-mce-object")?s(u.serializer.serialize(e,{selection:!0})):{}}(u.selection.getNode()),c=t.width,n=t.height;var r={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:u.selection.getNode().getAttribute("data-mce-object")?u.selection.getContent():void 0,multiline:!0,label:"Source"};r[l]=function(){t=s(this.value()),this.parent().parent().fromJSON(t)},o=u.windowManager.open({title:"Insert/edit video",data:t,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){t=s(this.next().find("#embed").value()),this.fromJSON(t)},items:i},{title:"Embed",type:"container",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(a(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},r]}],onSubmit:function(){var e,t,i,r;for(e=u.dom.select("img[data-mce-object]"),u.insertContent(a(this.toJSON())),t=u.dom.select("img[data-mce-object]"),i=0;i<e.length;i++)for(r=t.length-1;0<=r;r--)e[i]==t[r]&&t.splice(r,1);u.selection.select(t[0]),u.nodeChanged()}})}function a(a){var e="";if(!a.source1&&(tinymce.extend(a,s(a.embed)),!a.source1))return"";if(a.source2||(a.source2=""),a.poster||(a.poster=""),a.source1=u.convertURL(a.source1,"source"),a.source2=u.convertURL(a.source2,"source"),a.source1mime=o(a.source1),a.source2mime=o(a.source2),a.poster=u.convertURL(a.poster,"poster"),a.flashPlayerUrl=u.convertURL(r+"/moxieplayer.swf","movie"),tinymce.each(n,function(e){var t,i,r;if(t=e.regex.exec(a.source1)){for(r=e.url,i=0;t[i];i++)r=r.replace("$"+i,function(){return t[i]});a.source1=r,a.type=e.type,a.allowFullscreen=e.allowFullscreen,a.width=a.width||e.w,a.height=a.height||e.h}}),a.embed)e=c(a.embed,a,!0);else{var t=d(a.source1);if(t&&(a.type="script",a.width=t.width,a.height=t.height),a.width=a.width||300,a.height=a.height||150,tinymce.each(a,function(e,t){a[t]=u.dom.encode(e)}),"iframe"==a.type){var i=a.allowFullscreen?' allowFullscreen="1"':"";e+='<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"'+i+"></iframe>"}else"application/x-shockwave-flash"==a.source1mime?(e+='<object data="'+a.source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">',a.poster&&(e+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'),e+="</object>"):-1!=a.source1mime.indexOf("audio")?u.settings.audio_template_callback?e=u.settings.audio_template_callback(a):e+='<audio controls="controls" src="'+a.source1+'">'+(a.source2?'\n<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</audio>":"script"==a.type?e+='<script src="'+a.source1+'"><\/script>':e=u.settings.video_template_callback?u.settings.video_template_callback(a):'<video width="'+a.width+'" height="'+a.height+'"'+(a.poster?' poster="'+a.poster+'"':"")+' controls="controls">\n<source src="'+a.source1+'"'+(a.source1mime?' type="'+a.source1mime+'"':"")+" />\n"+(a.source2?'<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</video>"}return e}function s(e){var r={};return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(e,t){if(r.source1||"param"!=e||(r.source1=t.map.movie),"iframe"!=e&&"object"!=e&&"embed"!=e&&"video"!=e&&"audio"!=e||(r.type||(r.type=e),r=tinymce.extend(t.map,r)),"script"==e){var i=d(t.map.src);if(!i)return;r={type:"script",source1:t.map.src,width:i.width,height:i.height}}"source"==e&&(r.source1?r.source2||(r.source2=t.map.src):r.source1=t.map.src),"img"!=e||r.poster||(r.poster=t.map.src)}}).parse(e),r.source1=r.source1||r.src||r.data,r.source2=r.source2||"",r.poster=r.poster||"",r}function h(e){if(!1===u.settings.media_filter_html)return e;var a,o=new tinymce.html.Writer;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(e){o.comment(e)},cdata:function(e){o.cdata(e)},text:function(e,t){o.text(e,t)},start:function(e,t,i){if(a=!0,"script"!=e&&"noscript"!=e){for(var r=0;r<t.length;r++){if(0===t[r].name.indexOf("on"))return;"style"==t[r].name&&(t[r].value=u.dom.serializeStyle(u.dom.parseStyle(t[r].value),e))}o.start(e,t,i),a=!1}},end:function(e){a||o.end(e)}},new tinymce.html.Schema({})).parse(e),o.getContent()}function c(e,a,o){function c(e,t){var i,r,a,o;for(i in t)if(a=""+t[i],e.map[i])for(r=e.length;r--;)(o=e[r]).name==i&&(a?(e.map[i]=a,o.value=a):(delete e.map[i],e.splice(r,1)));else a&&(e.push({name:i,value:a}),e.map[i]=a)}var n,s=new tinymce.html.Writer,l=0;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(e){s.comment(e)},cdata:function(e){s.cdata(e)},text:function(e,t){s.text(e,t)},start:function(e,t,i){switch(e){case"video":case"object":case"embed":case"img":case"iframe":c(t,{width:a.width,height:a.height})}if(o)switch(e){case"video":c(t,{poster:a.poster,src:""}),a.source2&&c(t,{src:""});break;case"iframe":c(t,{src:a.source1});break;case"source":if(++l<=2&&(c(t,{src:a["source"+l],type:a["source"+l+"mime"]}),!a["source"+l]))return;break;case"img":if(!a.poster)return;n=!0}s.start(e,t,i)},end:function(e){if("video"==e&&o)for(var t=1;t<=2;t++)if(a["source"+t]){var i=[];i.map={},l<t&&(c(i,{src:a["source"+t],type:a["source"+t+"mime"]}),s.start("source",i,!0))}if(a.poster&&"object"==e&&o&&!n){var r=[];r.map={},c(r,{src:a.poster,width:a.width,height:a.height}),s.start("img",r,!0)}s.end(e)}},new tinymce.html.Schema({})).parse(e),s.getContent()}var n=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowfullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowfullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1}],l=tinymce.Env.ie&&tinymce.Env.ie<=8?"onChange":"onInput";u.on("ResolveName",function(e){var t;1==e.target.nodeType&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t)}),u.on("preInit",function(){var t=u.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(e){t[e]=new RegExp("</"+e+"[^>]*>","gi")});var i=u.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(e){i[e]={}}),u.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(e,t){for(var i,r,a,o,c,n,s,l,m=e.length;m--;)if((r=e[m]).parent&&("script"!=r.name||(l=d(r.attr("src"))))){for((a=new tinymce.html.Node("img",1)).shortEnded=!0,l&&(l.width&&r.attr("width",l.width.toString()),l.height&&r.attr("height",l.height.toString())),i=(n=r.attributes).length;i--;)o=n[i].name,c=n[i].value,"width"!==o&&"height"!==o&&"style"!==o&&("data"!=o&&"src"!=o||(c=u.convertURL(c,o)),a.attr("data-mce-p-"+o,c));(s=r.firstChild&&r.firstChild.value)&&(a.attr("data-mce-html",escape(s)),a.firstChild=null),a.attr({width:r.attr("width")||"300",height:r.attr("height")||("audio"==t?"30":"150"),style:r.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":t,class:"mce-object mce-object-"+t}),r.replace(a)}}),u.serializer.addAttributeFilter("data-mce-object",function(e,t){for(var i,r,a,o,c,n,s,l=e.length;l--;)if((i=e[l]).parent){for(s=i.attr(t),r=new tinymce.html.Node(s,1),"audio"!=s&&"script"!=s&&r.attr({width:i.attr("width"),height:i.attr("height")}),r.attr({style:i.attr("style")}),a=(o=i.attributes).length;a--;){var m=o[a].name;0===m.indexOf("data-mce-p-")&&r.attr(m.substr(11),o[a].value)}"script"==s&&r.attr("type","text/javascript"),(c=i.attr("data-mce-html"))&&((n=new tinymce.html.Node("#text",3)).raw=!0,n.value=h(unescape(c)),r.append(n)),i.replace(r)}})}),u.on("ObjectSelected",function(e){var t=e.target.getAttribute("data-mce-object");"audio"!=t&&"script"!=t||e.preventDefault()}),u.on("objectResized",function(e){var t,i=e.target;!i.getAttribute("data-mce-object")||(t=i.getAttribute("data-mce-html"))&&(t=unescape(t),i.setAttribute("data-mce-html",escape(c(t,{width:e.width,height:e.height}))))}),u.addButton("media",{tooltip:"Insert/edit video",onclick:e,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe]"]}),u.addMenuItem("media",{icon:"media",text:"Insert/edit video",onclick:e,context:"insert",prependToContext:!0}),this.showDialog=e});