tinymce.PluginManager.add("link",function(y){function t(e){return function(){var t=y.settings.link_list;"string"==typeof t?tinymce.util.XHR.send({url:t,success:function(t){e(tinymce.util.JSON.parse(t))}}):"function"==typeof t?t(e):e(t)}}function b(t,l,e){return function n(t,i){return i=i||[],tinymce.each(t,function(t){var e={text:t.text||t.title};t.menu?e.menu=n(t.menu):(e.value=t.value,l&&l(e)),i.push(e)}),i}(t,e||[])}function e(t){function e(t){var e=s.find("#text");(!e.value()||t.lastControl&&e.value()==t.lastControl.text())&&e.value(t.control.text()),s.find("#href").value(t.control.value())}function n(){!a&&0===m.text.length&&o&&this.parent().parent().find("#text")[0].value(this.value())}var i,l,a,s,o,r,u,c,f,d,g,x,h,v,m={},k=y.selection,p=y.dom;i=k.getNode(),l=p.getParent(i,"a[href]"),o=function(t){var e=k.getContent();if(/</.test(e)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(e)||-1==e.indexOf("href=")))return!1;if(t){var n,i=t.childNodes;if(0===i.length)return!1;for(n=i.length-1;0<=n;n--)if(3!=i[n].nodeType)return!1}return!0}(),m.text=a=l?l.innerText||l.textContent:k.getContent({format:"text"}),m.href=l?p.getAttrib(l,"href"):"",l?m.target=p.getAttrib(l,"target"):y.settings.default_link_target&&(m.target=y.settings.default_link_target),(x=p.getAttrib(l,"rel"))&&(m.rel=x),(x=p.getAttrib(l,"class"))&&(m.class=x),(x=p.getAttrib(l,"title"))&&(m.title=x),o&&(r={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){m.text=this.value()}}),t&&(u={type:"listbox",label:"Link list",values:b(t,function(t){t.value=y.convertURL(t.value||t.url,"href")},[{text:"None",value:""}]),onselect:e,value:y.convertURL(m.href,"href"),onPostRender:function(){u=this}}),!1!==y.settings.target_list&&(y.settings.target_list||(y.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),f={name:"target",type:"listbox",label:"Target",values:b(y.settings.target_list)}),y.settings.rel_list&&(c={name:"rel",type:"listbox",label:"Rel",values:b(y.settings.rel_list)}),y.settings.link_class_list&&(d={name:"class",type:"listbox",label:"Class",values:b(y.settings.link_class_list,function(t){t.value&&(t.textStyle=function(){return y.formatter.getCssText({inline:"a",classes:[t.value]})})})}),!1!==y.settings.link_title&&(g={name:"title",type:"textbox",label:"Title",value:m.title}),s=y.windowManager.open({title:"Insert link",data:m,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:function(t){var e=t.meta||{};u&&u.value(y.convertURL(this.value(),"href")),tinymce.each(t.meta,function(t,e){s.find("#"+e).value(t)}),e.text||n.call(this)},onkeyup:n},r,g,(h=m.href,v=[],tinymce.each(y.dom.select("a:not([href])"),function(t){var e=t.name||t.id;e&&v.push({text:e,value:"#"+e,selected:-1!=h.indexOf("#"+e)})}),v.length?(v.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:v,onselect:e}):void 0),u,c,f,d],onSubmit:function(t){function e(t,e){var n=y.selection.getRng();window.setTimeout(function(){y.windowManager.confirm(t,function(t){y.selection.setRng(n),e(t)})},0)}function n(){var t={href:i,target:m.target?m.target:null,rel:m.rel?m.rel:null,class:m.class?m.class:null,title:m.title?m.title:null};l?(y.focus(),o&&m.text!=a&&("innerText"in l?l.innerText=m.text:l.textContent=m.text),p.setAttribs(l,t),k.select(l),y.undoManager.add()):o?y.insertContent(p.createHTML("a",t,p.encode(m.text))):y.execCommand("mceInsertLink",!1,t)}var i;return m=tinymce.extend(m,t.data),(i=m.href)?0<i.indexOf("@")&&-1==i.indexOf("//")&&-1==i.indexOf("mailto:")?void e("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(t){t&&(i="mailto:"+i),n()}):y.settings.link_assume_external_targets&&!/^\w+:/i.test(i)||!y.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(i)?void e("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(t){t&&(i="http://"+i),n()}):void n():void y.execCommand("unlink")}})}y.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:t(e),stateSelector:"a[href]"}),y.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),y.addShortcut("Meta+K","",t(e)),y.addCommand("mceLink",t(e)),this.showDialog=e,y.addMenuItem("link",{icon:"link",text:"Insert/edit link",shortcut:"Meta+K",onclick:t(e),stateSelector:"a[href]",context:"insert",prependToContext:!0})});