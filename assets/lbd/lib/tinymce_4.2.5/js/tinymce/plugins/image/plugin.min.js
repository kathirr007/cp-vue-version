tinymce.PluginManager.add("image",function(f){function b(t,a,e){return function i(t,n){return n=n||[],tinymce.each(t,function(t){var e={text:t.text||t.title};t.menu?e.menu=i(t.menu):(e.value=t.value,a(e)),n.push(e)}),n}(t,e||[])}function t(e){return function(){var t=f.settings.image_list;"string"==typeof t?tinymce.util.XHR.send({url:t,success:function(t){e(tinymce.util.JSON.parse(t))}}):"function"==typeof t?t(e):e(t)}}function e(t){function e(){var t,e,i,n;t=l.find("#width")[0],e=l.find("#height")[0],t&&e&&(i=t.value(),n=e.value(),l.find("#constrain")[0].checked()&&o&&s&&i&&n&&(o!=i?(n=Math.round(i/o*n),isNaN(n)||e.value(n)):(i=Math.round(n/s*i),isNaN(i)||t.value(i))),o=i,s=n)}function i(){r(),e(),(c=tinymce.extend(c,l.toJSON())).alt||(c.alt=""),c.title||(c.title=""),""===c.width&&(c.width=null),""===c.height&&(c.height=null),c.style||(c.style=null),c={src:c.src,alt:c.alt,title:c.title,width:c.width,height:c.height,style:c.style,class:c.class},f.undoManager.transact(function(){return c.src?(""===c.title&&(c.title=null),h?d.setAttribs(h,c):(c.id="__mcenew",f.focus(),f.selection.setContent(d.createHTML("img",c)),h=d.get("__mcenew"),d.setAttrib(h,"id",null)),void function(t){function e(){t.onload=t.onerror=null,f.selection&&(f.selection.select(t),f.nodeChanged())}t.onload=function(){c.width||c.height||!u||d.setAttribs(t,{width:t.clientWidth,height:t.clientHeight}),e()},t.onerror=e}(h)):void(h&&(d.remove(h),f.focus(),f.nodeChanged()))})}function n(t){return t&&(t=t.replace(/px$/,"")),t}function a(t){if(t.margin){var e=t.margin.split(" ");switch(e.length){case 1:t["margin-top"]=t["margin-top"]||e[0],t["margin-right"]=t["margin-right"]||e[0],t["margin-bottom"]=t["margin-bottom"]||e[0],t["margin-left"]=t["margin-left"]||e[0];break;case 2:t["margin-top"]=t["margin-top"]||e[0],t["margin-right"]=t["margin-right"]||e[1],t["margin-bottom"]=t["margin-bottom"]||e[0],t["margin-left"]=t["margin-left"]||e[1];break;case 3:t["margin-top"]=t["margin-top"]||e[0],t["margin-right"]=t["margin-right"]||e[1],t["margin-bottom"]=t["margin-bottom"]||e[2],t["margin-left"]=t["margin-left"]||e[1];break;case 4:t["margin-top"]=t["margin-top"]||e[0],t["margin-right"]=t["margin-right"]||e[1],t["margin-bottom"]=t["margin-bottom"]||e[2],t["margin-left"]=t["margin-left"]||e[3]}delete t.margin}return t}function r(){function t(t){return 0<t.length&&/^[0-9]+$/.test(t)&&(t+="px"),t}if(f.settings.image_advtab){var e=l.toJSON(),i=d.parseStyle(e.style);i=a(i),e.vspace&&(i["margin-top"]=i["margin-bottom"]=t(e.vspace)),e.hspace&&(i["margin-left"]=i["margin-right"]=t(e.hspace)),e.border&&(i["border-width"]=t(e.border)),l.find("#style").value(d.serializeStyle(d.parseStyle(d.serializeStyle(i))))}}var l,o,s,g,m,c={},d=f.dom,h=f.selection.getNode(),u=!1!==f.settings.image_dimensions;o=d.getAttrib(h,"width"),s=d.getAttrib(h,"height"),"IMG"!=h.nodeName||h.getAttribute("data-mce-object")||h.getAttribute("data-mce-placeholder")?h=null:c={src:d.getAttrib(h,"src"),alt:d.getAttrib(h,"alt"),title:d.getAttrib(h,"title"),class:d.getAttrib(h,"class"),width:o,height:s},t&&(g={type:"listbox",label:"Image list",values:b(t,function(t){t.value=f.convertURL(t.value||t.url,"src")},[{text:"None",value:""}]),value:c.src&&f.convertURL(c.src,"src"),onselect:function(t){var e=l.find("#alt");(!e.value()||t.lastControl&&e.value()==t.lastControl.text())&&e.value(t.control.text()),l.find("#src").value(t.control.value()).fire("change")},onPostRender:function(){g=this}}),f.settings.image_class_list&&(m={name:"class",type:"listbox",label:"Class",values:b(f.settings.image_class_list,function(t){t.value&&(t.textStyle=function(){return f.formatter.getCssText({inline:"img",classes:[t.value]})})})});var p=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:function(t){var e,i,n,a=t.meta||{};g&&g.value(f.convertURL(this.value(),"src")),tinymce.each(a,function(t,e){l.find("#"+e).value(t)}),a.width||a.height||(e=f.convertURL(this.value(),"src"),i=f.settings.image_prepend_url,n=new RegExp("^(?:[a-z]+:)?//","i"),i&&!n.test(e)&&e.substring(0,i.length)!==i&&(e=i+e),this.value(e),function(t,i){function e(t,e){n.parentNode&&n.parentNode.removeChild(n),i({width:t,height:e})}var n=document.createElement("img");n.onload=function(){e(Math.max(n.width,n.clientWidth),Math.max(n.height,n.clientHeight))},n.onerror=function(){e()};var a=n.style;a.visibility="hidden",a.position="fixed",a.bottom=a.left=0,a.width=a.height="auto",document.body.appendChild(n),n.src=t}(f.documentBaseURI.toAbsolute(this.value()),function(t){t.width&&t.height&&u&&(o=t.width,s=t.height,l.find("#width").value(o),l.find("#height").value(s))}))}},g];!1!==f.settings.image_description&&p.push({name:"alt",type:"textbox",label:"Image description"}),f.settings.image_title&&p.push({name:"title",type:"textbox",label:"Image Title"}),u&&p.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:e,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:e,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),p.push(m),l=f.settings.image_advtab?(h&&(h.style.marginLeft&&h.style.marginRight&&h.style.marginLeft===h.style.marginRight&&(c.hspace=n(h.style.marginLeft)),h.style.marginTop&&h.style.marginBottom&&h.style.marginTop===h.style.marginBottom&&(c.vspace=n(h.style.marginTop)),h.style.borderWidth&&(c.border=n(h.style.borderWidth)),c.style=f.dom.serializeStyle(f.dom.parseStyle(f.dom.getAttrib(h,"style")))),f.windowManager.open({title:"Insert/edit image",data:c,bodyType:"tabpanel",body:[{title:"General",type:"form",items:p},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:function(){if(f.settings.image_advtab){var t=l.toJSON(),e=d.parseStyle(t.style);l.find("#vspace").value(""),l.find("#hspace").value(""),((e=a(e))["margin-top"]&&e["margin-bottom"]||e["margin-right"]&&e["margin-left"])&&(e["margin-top"]===e["margin-bottom"]?l.find("#vspace").value(n(e["margin-top"])):l.find("#vspace").value(""),e["margin-right"]===e["margin-left"]?l.find("#hspace").value(n(e["margin-right"])):l.find("#hspace").value("")),e["border-width"]&&l.find("#border").value(n(e["border-width"])),l.find("#style").value(d.serializeStyle(d.parseStyle(d.serializeStyle(e))))}}},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:r},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:i})):f.windowManager.open({title:"Insert/edit image",data:c,body:p,onSubmit:i})}f.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:t(e),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"}),f.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:t(e),context:"insert",prependToContext:!0}),f.addCommand("mceImage",t(e))});