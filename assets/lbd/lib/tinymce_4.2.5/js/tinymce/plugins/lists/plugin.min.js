tinymce.PluginManager.add("lists",function(C){function v(e){return e&&/^(OL|UL|DL)$/.test(e.nodeName)}function g(e){return e.parentNode.firstChild==e}function N(e){return e.parentNode.lastChild==e}function y(e){return e&&!!C.schema.getTextBlockElements()[e.nodeName]}var n=this;C.on("init",function(){function a(o){function e(e){var t,n,r;n=o[e?"startContainer":"endContainer"],r=o[e?"startOffset":"endOffset"],1==n.nodeType&&(t=u.create("span",{"data-mce-type":"bookmark"}),n.hasChildNodes()?(r=Math.min(r,n.childNodes.length-1),e?n.insertBefore(t,n.childNodes[r]):u.insertAfter(t,n.childNodes[r])):n.appendChild(t),n=t,r=0),i[e?"startContainer":"endContainer"]=n,i[e?"startOffset":"endOffset"]=r}var i={};return e(!0),o.collapsed||e(),i}function d(o){function e(e){var t,n,r;t=r=o[e?"startContainer":"endContainer"],n=o[e?"startOffset":"endOffset"],t&&(1==t.nodeType&&(n=function(e){for(var t=e.parentNode.firstChild,n=0;t;){if(t==e)return n;1==t.nodeType&&"bookmark"==t.getAttribute("data-mce-type")||n++,t=t.nextSibling}return-1}(t),t=t.parentNode,u.remove(r)),o[e?"startContainer":"endContainer"]=t,o[e?"startOffset":"endOffset"]=n)}e(!0),e();var t=u.createRng();t.setStart(o.startContainer,o.startOffset),o.endContainer&&t.setEnd(o.endContainer,o.endOffset),h.setRng(t)}function s(e,t){var n,r,o,i=u.createFragment(),a=C.schema.getBlockElements();if(C.settings.forced_root_block&&(t=t||C.settings.forced_root_block),t&&((r=u.create(t)).tagName===C.settings.forced_root_block&&u.setAttribs(r,C.settings.forced_root_block_attrs),i.appendChild(r)),e)for(;n=e.firstChild;){var d=n.nodeName;o||"SPAN"==d&&"bookmark"==n.getAttribute("data-mce-type")||(o=!0),a[d]?(i.appendChild(n),r=null):t?(r||(r=u.create(t),i.appendChild(r)),r.appendChild(n)):i.appendChild(n)}return C.settings.forced_root_block?o||tinymce.Env.ie&&!(10<tinymce.Env.ie)||r.appendChild(u.create("br",{"data-mce-bogus":"1"})):i.appendChild(u.create("br")),i}function f(){return tinymce.grep(h.getSelectedBlocks(),function(e){return/^(LI|DT|DD)$/.test(e.nodeName)})}function i(e,t,n){var r,o,i,a,d;for(i=u.select('span[data-mce-type="bookmark"]',e),n=n||s(t),(r=u.createRng()).setStartAfter(t),r.setEndAfter(e),a=(o=r.extractContents()).firstChild;a;a=a.firstChild)if("LI"==a.nodeName&&u.isEmpty(a)){u.remove(a);break}u.isEmpty(o)||u.insertAfter(o,e),u.insertAfter(n,e),u.isEmpty(t.parentNode)&&(d=t.parentNode,tinymce.each(i,function(e){d.parentNode.insertBefore(e,t.parentNode)}),u.remove(d)),u.remove(t),u.isEmpty(e)&&u.remove(e)}function l(e){var t,n;if((t=e.nextSibling)&&v(t)&&t.nodeName==e.nodeName){for(;n=t.firstChild;)e.appendChild(n);u.remove(t)}if((t=e.previousSibling)&&v(t)&&t.nodeName==e.nodeName){for(;n=t.firstChild;)e.insertBefore(n,e.firstChild);u.remove(t)}}function c(e){function t(e){u.isEmpty(e)&&u.remove(e)}var n,r=e.parentNode,o=r.parentNode;return"DD"==e.nodeName?u.rename(e,"DT"):g(e)&&N(e)?"LI"==o.nodeName?(u.insertAfter(e,o),t(o),u.remove(r)):v(o)?u.remove(r,!0):(o.insertBefore(s(e),r),u.remove(r)):g(e)?"LI"==o.nodeName?(u.insertAfter(e,o),e.appendChild(r),t(o)):v(o)?o.insertBefore(e,r):(o.insertBefore(s(e),r),u.remove(e)):N(e)?"LI"==o.nodeName?u.insertAfter(e,o):v(o)?u.insertAfter(e,r):(u.insertAfter(s(e),r),u.remove(e)):(n="LI"==o.nodeName?(r=o,s(e,"LI")):v(o)?s(e,"LI"):s(e),i(r,e,n),function(e){tinymce.each(tinymce.grep(u.select("ol,ul",e)),function(e){var t,n=e.parentNode;"LI"!=n.nodeName||n.firstChild!=e||(t=n.previousSibling)&&"LI"==t.nodeName&&(t.appendChild(e),u.isEmpty(n)&&u.remove(n)),!v(n)||(t=n.previousSibling)&&"LI"==t.nodeName&&t.appendChild(e)})}(r.parentNode)),!0}function r(r){function e(e,t){var n;if(v(e)){for(;n=r.lastChild.firstChild;)t.appendChild(n);u.remove(e)}}var t,n;return"DT"==r.nodeName?(u.rename(r,"DD"),!0):(t=r.previousSibling)&&v(t)?(t.appendChild(r),!0):t&&"LI"==t.nodeName&&v(t.lastChild)?(t.lastChild.appendChild(r),e(r.lastChild,t.lastChild),!0):(t=r.nextSibling)&&v(t)?(t.insertBefore(r,t.firstChild),!0):(!t||"LI"!=t.nodeName||!v(r.lastChild))&&(!(!(t=r.previousSibling)||"LI"!=t.nodeName)&&(n=u.create(r.parentNode.nodeName),t.appendChild(n),n.appendChild(r),e(r.lastChild,n),!0))}function o(){var e=f();if(e.length){for(var t=a(h.getRng(!0)),n=0;n<e.length&&(r(e[n])||0!==n);n++);return d(t),C.nodeChanged(),!0}}function m(){var e=f();if(e.length){var t,n,r=a(h.getRng(!0)),o=C.getBody();for(t=e.length;t--;)for(var i=e[t].parentNode;i&&i!=o;){for(n=e.length;n--;)if(e[n]===i){e.splice(t,1);break}i=i.parentNode}for(t=0;t<e.length&&(c(e[t])||0!==t);t++);return d(r),C.nodeChanged(),!0}}function p(){var e=a(h.getRng(!0)),r=C.getBody();tinymce.each(f(),function(e){var t,n;if(u.isEmpty(e))c(e);else{for(t=e;t&&t!=r;t=t.parentNode)v(t)&&(n=t);i(n,e)}}),d(e)}function e(e){var t=u.getParent(h.getStart(),"OL,UL,DL");if(t)if(t.nodeName==e)p();else{var n=a(h.getRng(!0));l(u.rename(t,e)),d(n)}else!function(r){var s=h.getRng(!0),e=a(s),o="LI";"DL"==(r=r.toUpperCase())&&(o="DT"),tinymce.each(function(){function e(e){var t,n;for(t=s[e?"startContainer":"endContainer"],n=s[e?"startOffset":"endOffset"],1==t.nodeType&&(t=t.childNodes[Math.min(n,t.childNodes.length-1)]||t);t.parentNode!=o;){if(y(t))return t;if(/^(TD|TH)$/.test(t.parentNode.nodeName))return t;t=t.parentNode}return t}for(var n,r=[],o=C.getBody(),t=e(!0),i=e(),a=[],d=t;d&&(a.push(d),d!=i);d=d.nextSibling);return tinymce.each(a,function(e){if(y(e))return r.push(e),void(n=null);if(u.isBlock(e)||"BR"==e.nodeName)return"BR"==e.nodeName&&u.remove(e),void(n=null);var t=e.nextSibling;return tinymce.dom.BookmarkManager.isBookmarkNode(e)&&(y(t)||!t&&e.parentNode==o)?void(n=null):(n||(n=u.create("p"),e.parentNode.insertBefore(n,e),r.push(n)),void n.appendChild(e))}),r}(),function(e){var t,n;(n=e.previousSibling)&&v(n)&&n.nodeName==r?(t=n,e=u.rename(e,o),n.appendChild(e)):(t=u.create(r),e.parentNode.insertBefore(t,e),t.appendChild(e),e=u.rename(e,o)),l(t)}),d(e)}(e)}function t(t){return function(){var e=u.getParent(C.selection.getStart(),"UL,OL,DL");return e&&e.nodeName==t}}var u=C.dom,h=C.selection;n.backspaceDelete=function(e){function t(e,t){var n,r,o=e.parentNode;if(v(t.lastChild)&&(r=t.lastChild),(n=t.lastChild)&&"BR"==n.nodeName&&e.hasChildNodes()&&u.remove(n),u.isEmpty(t)&&u.$(t).empty(),!u.isEmpty(e))for(;n=e.firstChild;)t.appendChild(n);r&&t.appendChild(r),u.remove(e),u.isEmpty(o)&&u.remove(o)}if(h.isCollapsed()){var n=u.getParent(h.getStart(),"LI");if(n){var r=h.getRng(!0),o=u.getParent(function(e,t){var n,r,o=e.startContainer,i=e.startOffset;if(3==o.nodeType&&(t?i<o.data.length:0<i))return o;for(n=C.schema.getNonEmptyElements(),r=new tinymce.dom.TreeWalker(e.startContainer);o=r[t?"next":"prev"]();){if("LI"==o.nodeName&&!o.hasChildNodes())return o;if(n[o.nodeName])return o;if(3==o.nodeType&&0<o.data.length)return o}}(r,e),"LI");if(o&&o!=n){var i=a(r);return e?t(o,n):t(n,o),d(i),!0}if(!o&&!e&&p(n.parentNode.nodeName))return!0}}},C.on("BeforeExecCommand",function(e){var t,n=e.command.toLowerCase();return"indent"==n?o()&&(t=!0):"outdent"==n&&m()&&(t=!0),t?(C.fire("ExecCommand",{command:e.command}),e.preventDefault(),!0):void 0}),C.addCommand("InsertUnorderedList",function(){e("UL")}),C.addCommand("InsertOrderedList",function(){e("OL")}),C.addCommand("InsertDefinitionList",function(){e("DL")}),C.addQueryStateHandler("InsertUnorderedList",t("UL")),C.addQueryStateHandler("InsertOrderedList",t("OL")),C.addQueryStateHandler("InsertDefinitionList",t("DL")),C.on("keydown",function(e){9!=e.keyCode||tinymce.util.VK.metaKeyPressed(e)||C.dom.getParent(C.selection.getStart(),"LI,DT,DD")&&(e.preventDefault(),e.shiftKey?m():o())})}),C.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var i=this;C.on("nodechange",function(){for(var e=C.selection.getSelectedBlocks(),t=!1,n=0,r=e.length;!t&&n<r;n++){var o=e[n].nodeName;t="LI"==o&&g(e[n])||"UL"==o||"OL"==o||"DD"==o}i.disabled(t)})}}),C.on("keydown",function(e){e.keyCode==tinymce.util.VK.BACKSPACE?n.backspaceDelete()&&e.preventDefault():e.keyCode==tinymce.util.VK.DELETE&&n.backspaceDelete(!0)&&e.preventDefault()})});