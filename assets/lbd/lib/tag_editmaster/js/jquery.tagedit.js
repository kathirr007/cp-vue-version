!function(u){u.fn.tagedit=function(d){if(d=u.extend(!0,{autocompleteURL:null,checkToDeleteURL:null,deletedPostfix:"-d",addedPostfix:"-a",additionalListClass:"",allowEdit:!0,allowDelete:!0,allowAdd:!0,direction:"ltr",animSpeed:500,autocompleteOptions:{select:function(e,t){return u(this).val(t.item.value).trigger("transformToTag",[t.item.id]),!1}},breakKeyCodes:[13,44],checkNewEntriesCaseSensitive:!1,texts:{removeLinkTitle:"Remove from list.",saveEditLinkTitle:"Save changes.",deleteLinkTitle:"Delete this tag from database.",deleteConfirmation:"Are you sure to delete this entry?",deletedElementTitle:"This Element will be deleted.",breakEditLinkTitle:"Cancel",forceDeleteConfirmation:"There are more records using this tag, are you sure do you want to remove it?"}},d||{}),0!=this.length){d.autocompleteURL&&(d.autocompleteOptions.source=d.autocompleteURL);var e=this.attr("dir");e&&0<e.length&&(d.direction=this.attr("dir"));var c=this,a=new RegExp("^(.*)\\[([0-9]*?("+d.deletedPostfix+"|"+d.addedPostfix+")?)?]$","i"),r=c.eq(0).attr("name").match(a);r&&4==r.length?(r=r[1],function(){var l='<ul class="tagedit-list '+d.additionalListClass+'">';c.each(function(){var e=u(this).attr("name").match(a);if(e&&4==e.length&&(0==d.deleteEmptyItems||0<u(this).val().length)&&0<e[1].length){var t=void 0!==e[2]?e[2]:"";l+='<li class="tagedit-listelement tagedit-listelement-old">',l+='<span dir="'+d.direction+'">'+u(this).val()+"</span>",l+='<input type="hidden" name="'+r+"["+t+']" value="'+u(this).val()+'"/>',l+='<a class="tagedit-close" title="'+d.texts.removeLinkTitle+'">x</a>',l+="</li>"}}),c.last().after(l);var e=c.last().next();c.remove(),c=e,0<d.deletedPostfix.length&&c.find('input[name$="'+d.deletedPostfix+']"]').each(function(){s(u(this).parent())});l='<li class="tagedit-listelement tagedit-listelement-new">',l+='<input type="text" name="'+r+'[]" value="" id="tagedit-input" disabled="disabled" class="tagedit-input-disabled" dir="'+d.direction+'"/>',l+="</li>",l+="</ul>",c.append(l).find("#tagedit-input").each(function(){u(this).autoGrowInput({comfortZone:15,minWidth:15,maxWidth:2e4}),u(this).bind("transformToTag",function(e,t){var i=void 0!==t&&(0<t.length||0<t),a=1!=i,n=o(u(this).val(),a);if((!0===n[0]||!1===n[0]&&"string"==typeof n[1])&&(0==i&&"string"==typeof n[1]&&(i=!0,t=n[1]),1==d.allowAdd||i)){l='<li class="tagedit-listelement tagedit-listelement-old">',l+='<span dir="'+d.direction+'">'+u(this).val()+"</span>";var s=i?r+"["+t+d.addedPostfix+"]":r+"[]";l+='<input type="hidden" name="'+s+'" value="'+u(this).val()+'" />',l+='<a class="tagedit-close" title="'+d.texts.removeLinkTitle+'">x</a>',l+="</li>",u(this).parent().before(l)}u(this).val(""),d.autocompleteOptions.source&&u(this).autocomplete("close")}).keydown(function(e){var t=0<e.keyCode?e.keyCode:e.which;switch(t){case 8:if(0!=u(this).val().length)break;var i=c.find("li.tagedit-listelement-old").last();return i.fadeOut(d.animSpeed,function(){i.remove()}),e.preventDefault(),!1;case 9:if(0<u(this).val().length&&0==u("ul.ui-autocomplete #ui-active-menuitem").length)return u(this).trigger("transformToTag"),e.preventDefault(),!1}return!0}).keypress(function(e){var t=0<e.keyCode?e.keyCode:e.which;return!(-1<u.inArray(t,d.breakKeyCodes))||(0<u(this).val().length&&0==u("ul.ui-autocomplete #ui-active-menuitem").length&&u(this).trigger("transformToTag"),e.preventDefault(),!1)}).bind("paste",function(e){var t=u(this);"paste"==e.type&&setTimeout(function(){t.trigger("transformToTag")},1)}).blur(function(){if(0==u(this).val().length)u(this).attr("disabled","disabled").addClass("tagedit-input-disabled");else{var e=u(this);u(this).data("blurtimer",window.setTimeout(function(){e.val("")},500))}}).focus(function(){window.clearTimeout(u(this).data("blurtimer"))}),0!=d.autocompleteOptions.source&&u(this).autocomplete(d.autocompleteOptions)}).end().click(function(e){switch(e.target.tagName){case"A":u(e.target).parent().fadeOut(d.animSpeed,function(){u(e.target).parent().remove()});break;case"INPUT":case"SPAN":case"LI":if(0==u(e.target).hasClass("tagedit-listelement-deleted")&&0==u(e.target).parent("li").hasClass("tagedit-listelement-deleted"))return function(e){if(0==d.allowEdit)return;var t="SPAN"==e.target.tagName?u(e.target).parent():u(e.target),n=null;t.bind("finishEdit",function(e,t){window.clearTimeout(n);var i=u(this).find(":text"),a=o(i.val(),!0);return 0<i.val().length&&(void 0===t||!1===t)&&1==a[0]&&(u(this).find(":hidden").val(i.val()),u(this).find("span").html(i.val())),i.remove(),u(this).find("a.tagedit-save, a.tagedit-break, a.tagedit-delete").remove(),u(this).removeClass("tagedit-listelement-edit").unbind("finishEdit"),!1});var i=t.find(":hidden");html='<input type="text" name="tmpinput" autocomplete="off" value="'+i.val()+'" class="tagedit-edit-input" dir="'+d.direction+'"/>',html+='<a class="tagedit-save" title="'+d.texts.saveEditLinkTitle+'">o</a>',html+='<a class="tagedit-break" title="'+d.texts.breakEditLinkTitle+'">x</a>',1==d.allowDelete&&0<t.find(":hidden").length&&void 0!==t.find(":hidden").attr("name").match(a)[3]&&(html+='<a class="tagedit-delete" title="'+d.texts.deleteLinkTitle+'">d</a>');i.after(html),t.addClass("tagedit-listelement-edit").find("a.tagedit-save").click(function(){return u(this).parent().trigger("finishEdit"),!1}).end().find("a.tagedit-break").click(function(){return u(this).parent().trigger("finishEdit",[!0]),!1}).end().find("a.tagedit-delete").click(function(){if(window.clearTimeout(n),confirm(d.texts.deleteConfirmation)){var e=function(e){if(null===d.checkToDeleteURL)return!1;var t=e.find("input:hidden").attr("name"),i=new RegExp("\\d"),a=t.match(i),n=!1;return u.ajax({async:!1,url:d.checkToDeleteURL,dataType:"json",type:"POST",data:{tagId:a},complete:function(e,t){var i=u.parseJSON(e.responseText);!0===i.success&&(n=i.allowDelete)}}),n}(u(this).parent());!e&&confirm(d.texts.forceDeleteConfirmation)&&s(u(this).parent()),e&&s(u(this).parent()),u(this).parent().find(":text").trigger("finishEdit",[!0])}else u(this).parent().find(":text").trigger("finishEdit",[!0]);return!1}).end().find(":text").focus().autoGrowInput({comfortZone:10,minWidth:15,maxWidth:2e4}).keypress(function(e){switch(e.keyCode){case 13:return e.preventDefault(),u(this).parent().trigger("finishEdit"),!1;case 27:return e.preventDefault(),u(this).parent().trigger("finishEdit",[!0]),!1}return!0}).blur(function(){var e=u(this);n=window.setTimeout(function(){e.parent().trigger("finishEdit",[!0])},500)})}(e);default:u(this).find("#tagedit-input").removeAttr("disabled").removeClass("tagedit-input-disabled").focus()}return!1})}()):alert("elementname dows not match the expected format (regexp: "+a+")")}function s(e){e.trigger("finishEdit",[!0]).addClass("tagedit-listelement-deleted").attr("title",d.deletedElementTitle),e.find(":hidden").each(function(){var e=new RegExp("("+d.addedPostfix+"|"+d.deletedPostfix+")?]"),t=u(this).attr("name").replace(e,d.deletedPostfix+"]");u(this).attr("name",t)})}function o(e,t){t=void 0!==t&&t;var i=null,a=1==d.checkNewEntriesCaseSensitive?e:e.toLowerCase(),n=!0;if(c.find("li.tagedit-listelement-old input:hidden").each(function(){(1==d.checkNewEntriesCaseSensitive?u(this).val():u(this).val().toLowerCase())==a&&(n=!1)}),1==n&&1==t&&0!=d.autocompleteOptions.source){var s=[];if(u.isArray(d.autocompleteOptions.source))s=d.autocompleteOptions.source;else if(u.isFunction(d.autocompleteOptions.source))d.autocompleteOptions.source({term:e},function(e){s=e});else if("string"==typeof d.autocompleteOptions.source){var l=d.autocompleteOptions.source;l.match(/\?/)?l+="&":l+="?",l+="term="+e,u.ajax({async:!1,url:l,dataType:"json",complete:function(e,t){s=u.parseJSON(e.responseText)}})}for(var r=0;r<s.length;r++){var o=s[r].label?s[r].label:s[r];if((1==d.checkNewEntriesCaseSensitive?o:o.toLowerCase())==a){n=!1,i="string"==typeof s[r]?r:s[r].id;break}}}return new Array(n,i)}}}(jQuery);