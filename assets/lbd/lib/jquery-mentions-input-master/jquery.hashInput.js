!function(R,L,e){function a(u){var f,t,n,a,o,r,h=[],s={},l=[],g="";function m(){var n=x();L.each(h,function(e){var t=u.templates.mentionItemSyntax(e);n=n.replace(new RegExp(N(e.value),"g"),t)});var a=n;L.each(h,function(e){var t=L.extend({},e,{value:e.value}),n=u.templates.mentionItemSyntax(t),i=u.templates.mentionItemHighlight(t);a=a.replace(new RegExp(N(n),"g"),i)}),a=(a=a.replace(/\n/g,"<br />")).replace(/ {2}/g,"&nbsp; "),f.data("messageText",n),f.trigger("updated"),o.find("div").html(a)}function v(){l=[]}function c(t){for(var e=x(),n=f[0].selectionStart,i=!1,a=!1,o=new RegExp("\\"+u.triggerChar+g,"gi");o.exec(e);)(!1===i||Math.abs(o.lastIndex-n)<i)&&(i=Math.abs(o.lastIndex-n),a=o.lastIndex);var r=a-g.length-1,s=a,l=e.substr(0,r),c=e.substr(s,e.length),d=(l+t.value).length+1;L.find(h,function(e){return e.id==t.id})||h.push(t),v(),g="",I();var p=l+u.triggerChar+t.value+" "+c;f.val(p),f.trigger("mention"),m(),f.focus(),$(f[0],d)}function x(){return R.trim(f.val())}function d(e){var t=R(this);return c(s[t.attr("datas-uid")]),function(){var e=R(f).offset().top,t=R("body").offset().top;e<R(window).scrollTop()&&R(window).scrollTop(e-t)}(),!1}function p(e){v();var t=this.selectionStart,n=x().substring(" ",t),a=n.substring(n.lastIndexOf(" ")+1).toLowerCase();if(a.charAt(0)===u.triggerChar){var o=a;for(i=0;i<o.length;i++)l.push(o[i]);L.defer(L.bind(E,this,o))}}function b(e){I()}function w(e){m(),function(){var n=x();h=L.reject(h,function(e,t){return!e.value||-1==n.indexOf(e.value)}),h=L.compact(h)}();var t=L.lastIndexOf(l,u.triggerChar);-1<t&&(g=l.slice(t+1).join(""),g=q(g),L.defer(L.bind(E,this,g)))}function y(e){if(e.keyCode!==A){var t=String.fromCharCode(e.which||e.keyCode);l.push(t)}}function C(e){if(e.keyCode===j||e.keyCode===z||e.keyCode===F||e.keyCode===V)return L.defer(v),void(-1<navigator.userAgent.indexOf("MSIE 9")&&L.defer(m));if(e.keyCode!==A){if(!n.is(":visible"))return!0;switch(e.keyCode){case H:var t=null;return(t=e.keyCode===H?r&&r.length?r.next():n.find("li").first():R(r).prev()).length&&T(t),!1;case O:case M:if(r&&r.length)return r.trigger("mousedown"),!1}return!0}l=l.slice(0,-1+l.length)}function I(){r=null,n.empty().hide()}function T(e){e.addClass(u.classes.autoCompleteItemActive),e.siblings().removeClass(u.classes.autoCompleteItemActive),r=e}function S(a,e){if(n.show(),!u.allowRepeat){var t=L.pluck(h,"value");e=L.reject(e,function(e){return L.include(t,e.name)})}if(e.length){n.empty();var o=R("<ul>").appendTo(n).hide();L.each(e,function(e,t){var n=L.uniqueId("mention_");s[n]=L.extend({},e,{value:e.name});var i=R(u.templates.autocompleteListItem({id:e.id,display:e.name,type:e.type,content:W(e.display?e.display:e.name,a)})).attr("datas-uid",n);0===t&&T(i),u.showAvatars&&(e.avatar?R(u.templates.autocompleteListItemAvatar({avatar:e.avatar})):R(u.templates.autocompleteListItemIcon({icon:e.icon}))).prependTo(i);i=i.appendTo(o)}),n.show(),u.onCaret&&function(e,t){var n=e.css("position");if("absolute"==n){var i=function(e){var t,n,i,a,o,r,s,l,c,d,p;if((c=e[0])&&R(c).is("textarea")&&null!=c.selectionEnd){for(s={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},d=0,p=(l=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;d<p;d++)s[o=l[d]]=R(c).css(o);return i=document.createElement("div"),R(i).css(s),R(c).after(i),n=document.createTextNode(c.value.substring(0,c.selectionEnd)),t=document.createTextNode(c.value.substring(c.selectionEnd)),(a=document.createElement("span")).innerHTML="&nbsp;",i.appendChild(n),i.appendChild(a),i.appendChild(t),i.scrollTop=c.scrollTop,r=R(a).position(),R(i).remove(),r}}(t),a=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",i.left),e.css("top",a+i.top);var o=t.offset().left+t.width(),r=e.offset().left+e.width();o<=r&&e.css("left",Math.abs(e.position().left-(r-o)))}else if("fixed"==n){var s=function(e){var t,n,i,a,o,r,s,l,c,d,p;if((c=e[0])&&R(c).is("textarea")&&null!=c.selectionEnd){for(s={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},d=0,p=(l=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;d<p;d++)s[o=l[d]]=R(c).css(o);return i=document.createElement("div"),R(i).css(s),R(c).after(i),n=document.createTextNode(c.value.substring(0,c.selectionEnd)),t=document.createTextNode(c.value.substring(c.selectionEnd)),(a=document.createElement("span")).innerHTML="&nbsp;",i.appendChild(n),i.appendChild(a),i.appendChild(t),i.scrollTop=c.scrollTop,r=R(a).offset(),R(i).remove(),r}}(t),a=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",s.left+1e4),e.css("top",a+s.top)}}(n,f),o.show()}else I()}function E(t){t&&t.length&&t.length>=u.minChars?u.onDataRequest.call(this,"search",t,function(e){S(t,e)}):I()}function k(e){h=[];for(var t,n=e,i=new RegExp("("+u.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),a=n;null!=(t=i.exec(n));)a=a.replace(t[0],t[1]+t[2]),h.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});f.val(a),m()}return u=R.extend(!0,{},D,u),{init:function(e){"true"!==(f=R(e)).attr("datas-mentions-input")&&(t=f.parent(),a=R(u.templates.wrapper()),f.wrapAll(a),a=t.find("> div.mentions-input-box"),f.attr("datas-mentions-input","true"),f.bind("keydown",C),f.bind("keypress",y),f.bind("click",p),f.bind("blur",b),-1<navigator.userAgent.indexOf("MSIE 8")?f.bind("propertychange",w):f.bind("input",w),u.elastic&&f.elastic()),(n=R(u.templates.autocompleteList())).appendTo(a),n.delegate("li","mousedown",d),(o=R(u.templates.mentionsOverlay())).prependTo(a),k(u.defaultValue),u.prefillMention&&c(u.prefillMention)},val:function(e){L.isFunction(e)&&e.call(this,h.length?f.data("messageText"):x())},reset:function(){k()},reinit:function(){k(!1)},getMentions:function(e){L.isFunction(e)&&e.call(this,h)}}}var A=8,M=9,O=13,j=37,z=39,H=40,F=36,V=35,D={defaultValue1:"",triggerChar:"#",onDataRequest:R.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:L.template('<div class="mentions-input-box"></div>'),autocompleteList:L.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:L.template('<li datas-ref-id="<%= id %>" datas-ref-type="<%= type %>" datas-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:L.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:L.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:L.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:L.template("[<%=value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:L.template("<strong><span><%=value %></span></strong>")}},N=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},W=function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},$=function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},q=function(e){return e.replace(/\s+$/,"")};R.fn.hashInput=function(t,n){var i=arguments;return"object"!=typeof t&&t||(n=t),this.each(function(){var e=R.data(this,"hashInput")||R.data(this,"hashInput",new a(n));return L.isFunction(e[t])?e[t].apply(this,Array.prototype.slice.call(i,1)):"object"!=typeof t&&t?void R.error("Method "+t+" does not exist"):e.init.call(this,this)})}}(jQuery,_);