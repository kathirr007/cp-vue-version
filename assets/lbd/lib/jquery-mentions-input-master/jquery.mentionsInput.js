!function(k,w,e){function i(t){var p,d,n,o,a,i,s,m,v=[],l=[];function f(){var n=g();w.each(v,function(e){var t=p.templates.mentionItemSyntax({value:e.value,type:e.type,id:e.id});n=n.replace(e.value,t)});var a=D(n);w.each(v,function(e){var t=p.templates.mentionItemSyntax({value:D(e.value),type:e.type,id:e.id}),n=p.templates.mentionItemHighlight({value:D(e.value)});a=a.replace(t,n)}),a=(a=a.replace(/\n/g,"<br />")).replace(/ {2}/g,"&nbsp; "),d.data("messageText",n),i.find("div").html(a)}function h(){l=[]}function g(){return k.trim(d.val())}function r(e){var t=k(this);return function(e,t,n){var a=g(),i=new RegExp("\\"+p.triggerChar+m,"gi");i.exec(a);var o=i.lastIndex-m.length-1,s=i.lastIndex,l=a.substr(0,o),r=a.substr(s,a.length),c=(l+e).length,u=l+e+r;v.push({id:t,type:n,value:e}),h(),m="",C(),d.val(u),f(),d.focus(),H(d[0],c)}(t.attr("data-display"),t.attr("data-ref-id"),t.attr("data-ref-type")),!1}function c(e){h()}function u(e){f(),function(){var n=g();v=w.reject(v,function(e,t){return!e.value||-1==n.indexOf(e.value)}),v=w.compact(v)}(),C();var t=w.lastIndexOf(l,p.triggerChar);-1<t&&(m=l.slice(t+1).join(""),m=M(m),w.defer(w.bind(b,this,m)))}function y(e){var t=String.fromCharCode(e.which||e.keyCode);l.push(t)}function I(e){if(e.keyCode!=R&&e.keyCode!=S&&e.keyCode!=F&&e.keyCode!=q){if(e.keyCode!=A){if(!o.is(":visible"))return!0;switch(e.keyCode){case j:case O:var t=null;return(t=e.keyCode==O?s&&s.length?s.next():o.find("li").first():k(s).prev()).length&&x(t),!1;case L:case T:if(s&&s.length)return s.click(),!1}return!0}l=l.slice(0,-1+l.length)}else w.defer(h)}function C(){s=null,o.empty().hide()}function x(e){e.addClass(p.classes.autoCompleteItemActive),e.siblings().removeClass(p.classes.autoCompleteItemActive),s=e}function b(t){t&&t.length&&t.length>=p.minChars&&p.onDataRequest.call(this,"search",t,function(e){!function(a,e){o.show();var t=w.pluck(v,"value");if((e=w.reject(e,function(e){return w.include(t,e.name)})).length){o.empty();var i=k("<ul>").appendTo(o).hide();w.each(e,function(e,t){var n=k(p.templates.autocompleteListItem({id:D(e.id),display:D(e.name),type:D(e.type),content:E(D(e.name),a)}));0===t&&x(n),p.showAvatars&&(e.avatar?k(p.templates.autocompleteListItemAvatar({avatar:e.avatar})):k(p.templates.autocompleteListItemIcon({icon:e.icon}))).prependTo(n),n=n.appendTo(i)}),o.show(),i.show()}else C()}(t,e)})}return{init:function(e){p=e,"true"!=(d=k(t)).attr("data-mentions-input")&&(n=d.parent(),a=k(p.templates.wrapper()),d.wrapAll(a),a=n.find("> div"),d.attr("data-mentions-input","true"),d.bind("keydown",I),d.bind("keypress",y),d.bind("input",u),d.bind("click",c),d.elastic()),(o=k(p.templates.autocompleteList())).appendTo(a),o.delegate("li","click",r),(i=k(p.templates.mentionsOverlay())).prependTo(a)},val:function(e){if(w.isFunction(e)){var t=v.length?d.data("messageText"):g();e.call(this,t)}},reset:function(){d.val(""),v=[],f()},getMentions:function(e){w.isFunction(e)&&e.call(this,v)}}}var A=8,T=9,L=13,R=37,j=38,S=39,O=40,F=36,q=35,o={triggerChar:"@",onDataRequest:k.noop,minChars:2,showAvatars:!0,classes:{autoCompleteItemActive:"active"},templates:{wrapper:w.template('<div class="mentions-input-box"></div>'),autocompleteList:w.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:w.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:w.template('<img  src="<%= avatar %>" />'),autocompleteListItemIcon:w.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:w.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:w.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:w.template("<strong><span><%= value %></span></strong>")}},D=function(e){return w.escape(e)},E=function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},H=function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},M=function(e){return e.replace(/\s+$/,"")};k.fn.mentionsInput=function(t,n){"object"!=typeof t&&t||(n=k.extend(!0,{},o,t));var a=arguments;return this.each(function(){var e=k.data(this,"mentionsInput")||k.data(this,"mentionsInput",new i(this));return w.isFunction(e[t])?e[t].apply(this,Array.prototype.slice.call(a,1)):"object"!=typeof t&&t?void k.error("Method "+t+" does not exist"):e.init.call(this,n)})}}(jQuery,_);